<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StorePi â€” Demo Store</title>
<meta name="description" content="StorePi demo â€” clean, professional Pi payments demo (server-approved flow). Forza Inter ðŸ’™" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300121f' width='100' height='100' rx='20'/><text x='50' y='62' font-size='48' text-anchor='middle' fill='%230a84ff' font-family='Arial'>Ï€</text></svg>">
<style>
  /* -------------------------
     THEME (Inter-inspired)
     ------------------------- */
  :root{
    --bg:#f7fbff;           /* soft off-white background */
    --header:#031428;       /* deep navy header */
    --card:#ffffff;         /* white cards */
    --ink:#042033;          /* main text */
    --muted:#687e92;        /* secondary text */
    --blue:#0a84ff;         /* electric blue accent */
    --navy:#062e58;         /* deep navy for headings/buttons */
    --yellow:#ffc857;       /* small accent (sparingly) */
    --success:#16a34a;
    --radius:12px;
    --shadow: 0 12px 36px rgba(6,18,28,0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    color-scheme: light;
  }

  /* -------------------------
     LAYOUT
     ------------------------- */
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
  .container{max-width:1100px;margin:26px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--header),#071a2b);box-shadow:var(--shadow);color:white}
  .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(180deg,var(--blue),var(--navy));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px}
  .title{line-height:1}
  .title h1{margin:0;font-size:18px}
  .title p{margin:3px 0 0;font-size:13px;color:rgba(255,255,255,0.85)}

  /* grid */
  .grid{display:grid;grid-template-columns:1fr;gap:18px;margin-top:18px}
  @media(min-width:920px){ .grid{grid-template-columns:1fr 360px} }

  /* cards */
  .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
  .hero{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .hero .headline{font-size:20px;color:var(--navy);margin:0}
  .hero .sub{color:var(--muted);margin-top:6px;font-size:14px}

  /* product */
  .product{display:flex;gap:16px;align-items:center;margin-top:14px}
  .thumb{width:140px;height:110px;border-radius:10px;background:linear-gradient(180deg,#eaf6ff,#dceeff);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--blue);font-size:40px;box-shadow:0 8px 20px rgba(6,18,28,0.06)}
  .meta{color:var(--muted);font-size:14px}
  .price{font-weight:800;font-size:18px;color:var(--blue)}

  /* actions */
  .controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,var(--blue),#0778e6);border:0;color:white;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(10,30,60,0.12);transition:transform .12s ease,box-shadow .12s ease}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent;border:1px solid rgba(6,18,28,0.06);color:var(--muted);padding:11px 14px}
  .status{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(10,20,30,0.02),rgba(10,20,30,0.01));color:var(--navy);display:inline-block}
  .log{margin-top:12px;background:#071827;padding:12px;border-radius:8px;color:#bfe8ff;font-family:monospace;white-space:pre-wrap;max-height:280px;overflow:auto}

  /* right column receipt */
  .receipt{display:flex;flex-direction:column;gap:8px}
  .receipt h3{margin:0;color:var(--navy)}
  .receipt .info{color:var(--muted);font-size:13px}
  .tx{font-family:monospace;color:var(--blue);word-break:break-all}

  /* misc */
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .tiny-yellow{background:linear-gradient(90deg,var(--yellow),#ffd77a);padding:6px 8px;border-radius:8px;color:#2b2b2b;font-weight:700;font-size:12px}
  .hidden{display:none}
  .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:3px solid rgba(255,255,255,0.18);border-top-color:white;animation:spin .8s linear infinite;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">SP</div>
      <div class="title">
        <h1>StorePi</h1>
        <p>Demo store â€” clean, secure Pi payments (server-approved flow)</p>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="tiny-yellow" title="small accent">Demo</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: main -->
      <main class="card" aria-labelledby="mainTitle">
        <div class="hero">
          <div>
            <div id="mainTitle" class="headline">Demo Product â€” Secure Purchase</div>
            <div class="sub">A minimal demo item to test Pi payments. Works in Pi Browser (server approval).</div>
          </div>
          <div style="text-align:right">
            <div class="price">0.01 Pi</div>
            <div style="color:var(--muted);font-size:13px">Pi Testnet</div>
          </div>
        </div>

        <div class="product" role="region" aria-label="Product">
          <div class="thumb">ðŸ›’</div>
          <div>
            <div style="font-weight:700;color:var(--navy)">Demo Store Item</div>
            <div class="meta">This is a demo item used to validate the payment integration. Nothing is charged for production.</div>

            <div class="controls">
              <button id="payBtn" class="btn">Buy â€” 0.01 Pi</button>
              <button id="authBtn" class="btn ghost">Authorize (payments)</button>
              <button id="checkBtn" class="btn ghost">Check SDK</button>
            </div>

            <div id="status" class="status">Status: idle</div>
            <div id="log" class="log" aria-live="polite">Logs will appear here...</div>
          </div>
        </div>
      </main>

      <!-- RIGHT: controls & receipt -->
      <aside>
        <div class="card receipt" id="receiptCard" aria-hidden="true">
          <h3>Receipt & Summary</h3>
          <div class="info" id="receiptMsg">No transactions yet â€” click Buy to start a test payment.</div>

          <div style="height:6px"></div>
          <div style="font-size:13px;color:var(--muted)">Payment ID</div>
          <div class="tx" id="paymentId">â€”</div>

          <div style="height:6px"></div>
          <div style="font-size:13px;color:var(--muted)">Transaction (txid)</div>
          <div class="tx" id="txid">â€”</div>

          <div style="height:12px"></div>
          <div style="display:flex;gap:8px">
            <button id="openTx" class="btn ghost">Open on Testnet</button>
            <button id="manualComplete" class="btn">Force Complete</button>
          </div>
        </div>
      </aside>
    </div>

    <footer>Made with <span style="color:var(--blue)">ðŸ’™</span> â€” Forza Inter!</footer>
  </div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* ---------- Frontend behavior (Pi SDK + server approve) ---------- */
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const payBtn = document.getElementById('payBtn');
const authBtn = document.getElementById('authBtn');
const checkBtn = document.getElementById('checkBtn');
const receiptCard = document.getElementById('receiptCard');
const receiptMsg = document.getElementById('receiptMsg');
const paymentIdEl = document.getElementById('paymentId');
const txidEl = document.getElementById('txid');
const openTx = document.getElementById('openTx');
const manualComplete = document.getElementById('manualComplete');

function now(){ return new Date().toISOString(); }
function appendLog(...parts){
  const t = parts.map(p => (typeof p === 'object' ? JSON.stringify(p) : String(p))).join(' ');
  const line = now() + '  ' + t;
  logEl.textContent = line + '\\n' + logEl.textContent;
  console.log(...parts);
}
function setStatus(s){ statusEl.textContent = 'Status: ' + s; appendLog('STATUS', s); }
function showReceipt(pid, tx, text){
  receiptCard.setAttribute('aria-hidden','false');
  receiptMsg.textContent = text || 'Payment completed';
  paymentIdEl.textContent = pid || 'â€”';
  txidEl.textContent = tx || 'â€”';
  openTx.onclick = ()=> { if (tx) window.open('https://api.testnet.minepi.com/transactions/' + tx, '_blank'); else alert('No txid'); };
}

/* init Pi SDK safely */
try {
  if (typeof Pi !== 'undefined' && typeof Pi.init === 'function') {
    Pi.init({ version: "2.0" });
    appendLog('Pi.init called (if in Pi Browser)');
  } else {
    appendLog('Pi object missing â€” open this app inside Pi Browser for live payments');
  }
} catch(e){ appendLog('Pi.init error', e); }

/* Check SDK */
checkBtn.addEventListener('click', ()=>{
  const present = typeof Pi !== 'undefined';
  const hasAuth = present && typeof Pi.authenticate === 'function';
  const hasCreate = present && typeof Pi.createPayment === 'function';
  appendLog('Pi presence:', present, 'authenticate:', hasAuth, 'createPayment:', hasCreate);
  setStatus('Checked SDK - see log');
});

/* Authorize */
authBtn.addEventListener('click', async ()=>{
  if (typeof Pi === 'undefined'){ alert('Open this page in Pi Browser to authorize'); return; }
  setStatus('Authenticating (requesting payments)...');
  appendLog('Calling Pi.authenticate with scopes ["payments"]');
  try {
    const result = await Pi.authenticate(['payments'], function(incomplete){ appendLog('authenticate incomplete callback', incomplete); });
    appendLog('authenticate resolved', result);
    setStatus('Authorized');
    alert('Authorized â€” you can now make payments');
  } catch(err){
    appendLog('Auth error', err);
    setStatus('Auth failed');
    alert('Authorization failed. Re-open from My Apps and try again.');
  }
});

/* Helper: talk to server approve endpoint */
async function serverApprove(paymentId, txid = null){
  try {
    const body = { paymentId };
    if (txid) body.txid = txid;
    const r = await fetch('/api/approve-payment', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    const txt = await r.text();
    appendLog('/api/approve-payment', r.status, txt);
    return { ok: r.ok, status: r.status, raw: txt };
  } catch(e){
    appendLog('serverApprove error', e);
    return { ok:false, error: String(e) };
  }
}

/* Buy flow (server-approve) */
payBtn.addEventListener('click', async ()=>{
  if (typeof Pi === 'undefined' || typeof Pi.createPayment !== 'function'){ alert('Open in Pi Browser and authorize first'); return; }
  setStatus('Creating payment...');
  appendLog('Pi.createPayment starting (server-approve flow)');
  const payload = { amount: 0.01, memo: 'StorePi Demo Payment', metadata: { demo:true } };

  const callbacks = {
    onReadyForServerApproval: async function(paymentId){
      appendLog('onReadyForServerApproval', paymentId);
      setStatus('Ready for approval: ' + paymentId + ' â€” requesting server');
      // request server to approve (no txid yet)
      const res = await serverApprove(paymentId, null);
      if (res.ok) setStatus('Server approved â€” waiting for completion');
      else setStatus('Server approval failed');
    },
    onReadyForServerCompletion: function(paymentId, txid){
      appendLog('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      showReceipt(paymentId, txid, 'Payment completed â€” thank you!');
      // inform server with txid (best-effort)
      serverApprove(paymentId, txid).then(r => appendLog('post-complete result', r));
    },
    onCancel: function(paymentId){
      appendLog('onCancel', paymentId);
      setStatus('Payment canceled');
      alert('Payment canceled');
    },
    onError: function(err, payment){
      appendLog('onError', err, payment);
      setStatus('Payment error');
      alert('Payment error â€” check logs');
    }
  };

  try {
    Pi.createPayment(payload, callbacks);
    appendLog('Pi.createPayment invoked');
  } catch(e){
    appendLog('createPayment threw', e);
    setStatus('createPayment threw error');
    alert('Error creating payment: ' + (e && e.message ? e.message : String(e)));
  }
});

/* Manual complete for support */
manualComplete.addEventListener('click', async ()=>{
  const pid = prompt('Payment ID to complete:');
  if (!pid) return;
  try {
    const r = await fetch('/api/manual-complete?paymentId=' + encodeURIComponent(pid));
    const txt = await r.text();
    appendLog('manual-complete', r.status, txt);
    alert('Manual-complete result: ' + txt);
  } catch(e){
    appendLog('manual-complete error', e);
    alert('Error');
  }
});
</script>
</body>
</html>
