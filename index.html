<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StorePi ‚Äî Buy with Pi</title>
  <meta name="description" content="Buy demo items with Pi. Server-approved payments, secure and fast.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23186fb4' width='100' height='100' rx='18'/><text x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'>œÄ</text></svg>">
  <style>
    :root{
      --bg:#f6fbff; --card:#ffffff; --muted:#64748b; --accent:#1867b4; --accent-2:#6c5ce7; --success:#16a34a;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: light;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f7fbff,#eef6fb);color:#073044}
    .wrap{max-width:980px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;gap:14px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(10,20,30,0.06)}
    .product{display:flex;gap:12px;align-items:center}
    .thumb{width:120px;height:100px;border-radius:10px;background:linear-gradient(180deg,#e6f2ff,#cfeaff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#083d62}
    .price{font-weight:700;font-size:20px;color:#083d62}
    button.btn{background:var(--accent);color:#fff;border:0;padding:12px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted);padding:10px 12px;border-radius:10px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .status{margin-top:10px;padding:10px;border-radius:8px;background:#e8f6ff;color:#064b6f}
    #log{margin-top:12px;background:#071427;padding:12px;border-radius:8px;color:#bfe8ff;font-family:monospace;white-space:pre-wrap;max-height:260px;overflow:auto}
    .muted{color:var(--muted);font-size:14px}
    .receipt{max-width:720px;margin:14px auto;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfeff);box-shadow:0 10px 30px rgba(10,20,30,0.06)}
    .tx{font-family:monospace;word-break:break-all;color:#003b5c}
    @media(min-width:720px){.grid{grid-template-columns:1fr 360px}}
    .hidden{display:none}
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.2);border-top-color:rgba(255,255,255,0.9);animation:spin .9s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .success-badge{display:inline-block;padding:6px 10px;background:linear-gradient(90deg,#dafbe7,#bff3d8);color:var(--success);border-radius:999px;font-weight:600}
    a.small{color:var(--accent-2);text-decoration:none}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">SP</div>
      <div>
        <h1>StorePi</h1>
        <p class="lead">Buy a demo item with Pi ‚Äî secure server approval flow. Open in <strong>Pi Browser</strong> to test live payments.</p>
      </div>
    </header>

    <main class="grid" role="main">
      <!-- product card -->
      <section class="card" aria-labelledby="productTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Featured product</div>
            <div id="productTitle" style="font-size:18px;font-weight:700">Digital Sticker Pack</div>
          </div>
          <div class="price">0.01 Pi</div>
        </div>

        <div style="height:12px"></div>

        <div class="product" aria-hidden="false">
          <div class="thumb" aria-hidden="true">üü£</div>
          <div style="flex:1">
            <div class="muted">Colorful stickers for chats and profiles. Delivered instantly after payment.</div>
            <div style="height:8px"></div>
            <div class="controls" role="group" aria-label="Actions">
              <button id="buyBtn" class="btn" aria-label="Buy for 0.01 Pi">Buy with Pi ‚Äî 0.01</button>
              <button id="authBtn" class="ghost" aria-label="Authorize app">Authorize (payments)</button>
              <button id="checkBtn" class="ghost" aria-label="Check Pi SDK">Check SDK</button>
            </div>
          </div>
        </div>

        <div id="status" class="status" aria-live="polite">Status: idle</div>
        <div id="log" aria-live="polite">Logs will appear here...</div>
      </section>

      <!-- right: receipt & help -->
      <aside class="card" aria-labelledby="helpTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong id="helpTitle">Quick Help</strong></div>
          <div class="muted">Mobile-first ‚Ä¢ Accessible</div>
        </div>

        <div style="margin-top:10px">
          <div class="muted">Server approval</div>
          <p style="margin:0">When a payment reaches ‚Äúready for approval‚Äù, the app asks the server to approve. The server must approve quickly (60s) or the SDK will show ‚ÄúPayment Expired‚Äù.</p>
        </div>

        <div style="height:12px"></div>

        <div id="receipt" class="receipt hidden" aria-hidden="true" role="region" aria-label="Receipt">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Receipt</strong></div>
            <div class="success-badge">Paid</div>
          </div>
          <div style="height:8px"></div>
          <div class="muted">Item: Digital Sticker Pack</div>
          <div style="height:6px"></div>
          <div>Amount: <strong>0.01 Pi</strong></div>
          <div style="height:6px"></div>
          <div>Payment ID: <div class="tx" id="receiptId"></div></div>
          <div style="height:6px"></div>
          <div>Tx ID: <div class="tx"><a id="txLink" class="small" target="_blank" rel="noreferrer noopener"></a></div></div>
          <div style="height:10px"></div>
          <button id="closeReceipt" class="ghost" style="width:100%">Close</button>
        </div>

        <div style="height:12px"></div>

        <div class="muted" style="font-size:13px">Developer notes:</div>
        <ul style="margin:6px 0 0 16px;color:var(--muted);font-size:14px">
          <li>Server endpoint: <code>/api/approve-payment</code></li>
          <li>Env var: <code>PI_API_KEY</code> (Vercel) and <code>ADMIN_TOKEN</code> (optional)</li>
        </ul>
      </aside>
    </main>

    <footer style="text-align:center;color:var(--muted);padding-top:18px">Made with ‚ù§Ô∏è ‚Äî StorePi demo</footer>
  </div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* ---------- configuration ---------- */
const ADMIN_TOKEN = 'REPLACE_WITH_ADMIN_TOKEN_IN_VERSEL_ENV'; // we will read real token from runtime header below
/* ---------- UI helpers ---------- */
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const buyBtn = document.getElementById('buyBtn');
const authBtn = document.getElementById('authBtn');
const checkBtn = document.getElementById('checkBtn');
const receiptEl = document.getElementById('receipt');
const receiptIdEl = document.getElementById('receiptId');
const txLinkEl = document.getElementById('txLink');
const closeReceipt = document.getElementById('closeReceipt');

function time(){ return new Date().toISOString(); }
function appendLog(...parts){
  const text = parts.map(p => (typeof p==='object'?JSON.stringify(p):String(p))).join(' ');
  const line = time() + '  ' + text;
  logEl.textContent = line + '\\n' + logEl.textContent;
  console.log(...parts);
}
function setStatus(s){ statusEl.textContent = 'Status: ' + s; appendLog('STATUS', s); }
function showReceipt(paymentId, txid){
  receiptEl.classList.remove('hidden'); receiptEl.setAttribute('aria-hidden','false');
  receiptIdEl.textContent = paymentId;
  txLinkEl.href = txid ? ('https://api.testnet.minepi.com/transactions/' + txid) : '#';
  txLinkEl.textContent = txid || '(no tx)';
}
function hideReceipt(){ receiptEl.classList.add('hidden'); receiptEl.setAttribute('aria-hidden','true'); }
closeReceipt.onclick = hideReceipt;

/* ---------- init Pi SDK ---------- */
try {
  if (typeof Pi !== 'undefined' && typeof Pi.init === 'function') {
    Pi.init({ version: '2.0' });
    appendLog('‚úÖ Pi SDK initialized');
  } else {
    appendLog('Pi object missing (open in Pi Browser)');
  }
} catch(e){ appendLog('Pi.init error', e); }

/* ---------- check ---------- */
checkBtn.addEventListener('click', () => {
  const present = typeof Pi !== 'undefined';
  const hasAuth = present && typeof Pi.authenticate === 'function';
  const hasCreate = present && typeof Pi.createPayment === 'function';
  appendLog('Pi present:', present, 'authenticate:', hasAuth, 'createPayment:', hasCreate);
  setStatus('Checked SDK - see log');
});

/* ---------- authorize ---------- */
authBtn.addEventListener('click', async () => {
  if (typeof Pi === 'undefined') { appendLog('Open in Pi Browser to authorize'); alert('Open this page in Pi Browser to authorize'); return; }
  setStatus('Authenticating (requesting payments scope)...');
  appendLog('Calling Pi.authenticate with scopes ["payments"]');
  try {
    const user = await Pi.authenticate(['payments'], (incomplete) => appendLog('authenticate incomplete callback', incomplete));
    appendLog('authenticate resolved', user);
    setStatus('Authorized');
  } catch(err) {
    appendLog('Auth error', err || '{}');
    setStatus('Auth failed');
    alert('Authorization failed. Try opening the app from Pi Browser -> My Apps and try again.');
  }
});

/* ---------- server call helper (reads response safely) ---------- */
async function postApprove(paymentId, txid = null){
  // ADMIN_TOKEN is stored in Vercel and injected into the page via server-side render? 
  // We can't read server env directly from static HTML; we rely on function to allow calls from here without admin token or you can set a short frontend token if you want.
  try {
    const body = { paymentId };
    if (txid) body.txid = txid;
    // Send admin token header if you configured it in project; it's optional.
    const headers = { 'Content-Type': 'application/json' };
    const adminToken = ''; // intentionally blank ‚Äî if you set ADMIN_TOKEN in env and want client to send it, replace '' with actual value at build-time with server-side rendering, or use safe admin panel.
    if (adminToken) headers['X-ADMIN-TOKEN'] = adminToken;

    const r = await fetch('/api/approve-payment', { method:'POST', headers, body: JSON.stringify(body) });
    const text = await r.text();
    try { return { status: r.status, ok: r.ok, body: JSON.parse(text) }; } catch(e) { return { status: r.status, ok: r.ok, body: { raw: text } }; }
  } catch(e){
    return { status: 0, ok:false, error: String(e) };
  }
}

/* ---------- buy flow ---------- */
buyBtn.addEventListener('click', async () => {
  hideReceipt();
  if (typeof Pi === 'undefined' || typeof Pi.createPayment !== 'function'){ appendLog('Pi.createPayment not available; open Pi Browser and authorize'); alert('Open in Pi Browser and authorize first'); return; }

  setStatus('Creating payment...');
  appendLog('about to call Pi.createPayment (server-approve flow)');

  const payload = { amount: 0.01, memo: 'StorePi Demo Payment', metadata: { productId: 'stickers-001' } };

  const callbacks = {
    onReadyForServerApproval: async function(paymentId){
      appendLog('onReadyForServerApproval', paymentId);
      setStatus('Ready for approval: ' + paymentId);

      // Ask server to approve immediately (no txid yet)
      setStatus('Requesting server approval...');
      const res = await postApprove(paymentId, null);
      appendLog('Server approve response', res.status, res.body || res.error);
      if (!res.ok) {
        setStatus('Server approval failed');
        alert('Server approval failed. You can retry or contact support.');
      } else {
        setStatus('Server approved ‚Äî waiting for completion');
      }
    },

    onReadyForServerCompletion: async function(paymentId, txid){
      appendLog('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      // After completion, also inform server of txid so it can mark complete if needed
      const res = await postApprove(paymentId, txid);
      appendLog('Server complete response', res.status, res.body || res.error);
      showReceipt(paymentId, txid);
    },

    onCancel: (paymentId) => {
      appendLog('onCancel', paymentId);
      setStatus('Payment canceled');
      alert('You cancelled the payment.');
    },

    onError: (err, payment) => {
      appendLog('onError', err, payment);
      setStatus('Payment error');
      alert('Payment error ‚Äî check logs.');
    }
  };

  try {
    Pi.createPayment(payload, callbacks);
    appendLog('Pi.createPayment invoked.');
  } catch(e) {
    appendLog('createPayment threw', e);
    setStatus('createPayment threw error');
    alert('Error creating payment: ' + String(e));
  }
});
</script>
</body>
</html>
