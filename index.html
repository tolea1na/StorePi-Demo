<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StorePi Demo â€” Server Approve</title>
<script src="https://sdk.minepi.com/pi-sdk.js" defer></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
<style>
  :root{
    --bg:#071327; --panel:#081827; --muted:#97a8bd; --text:#eaf6ff;
    --accent:#0b63ff; --gold:#d29b00;
    --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#031022,#071327);color:var(--text);font-family:Inter,system-ui,Arial}
  .wrap{display:flex;align-items:center;justify-content:center;padding:18px;min-height:100vh}
  .app{width:100%;max-width:420px;border-radius:18px;padding:18px;background:var(--panel);box-shadow:0 20px 60px rgba(0,0,0,0.6)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(180deg,var(--accent),#0647c2);display:flex;align-items:center;justify-content:center;font-size:28px}
  h1{font-size:18px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .cta{background:linear-gradient(180deg,var(--gold),#b37b00);border:0;padding:10px 12px;border-radius:12px;color:#071027;font-weight:700}
  .hero{display:flex;gap:12px;margin-top:14px;padding:12px;border-radius:12px;background:var(--card)}
  .search{margin-top:12px;display:flex;gap:10px}
  .search input{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
  .stats{display:flex;gap:10px;margin-top:12px}
  .stat{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;text-align:center}
  .grid{display:flex;gap:10px;margin-top:12px;overflow:auto;padding-bottom:8px}
  .card{min-width:170px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .actions{display:flex;gap:8px;margin-top:14px}
  .btn{padding:10px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#0a50d4);color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  #status{margin-top:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);color:var(--muted)}
  #log{margin-top:10px;background:#02101a;padding:12px;border-radius:10px;height:160px;overflow:auto;font-family:monospace;color:#bfe6ff;font-size:12px}
  footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center}
  @media (max-width:420px){ .grid .card{min-width:140px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="main" aria-live="polite">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden>ðŸ’™</div>
          <div>
            <h1>StorePi</h1>
            <p class="lead">Pi-native marketplace â€” demo</p>
          </div>
        </div>
        <button class="cta" id="createStore">+ Create</button>
      </header>

      <div class="hero">
        <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,var(--accent),#0a4fd1);display:flex;align-items:center;justify-content:center;font-size:34px">ðŸ’™</div>
        <div>
          <h2 style="margin:0">Sell with Pi â€” Demo</h2>
          <p style="margin-top:8px;color:var(--muted);font-size:13px">Open this app in Pi Browser to test real payments. Demo mode works anywhere.</p>
          <div style="margin-top:10px">
            <button class="btn primary" id="checkSdk">Check SDK</button>
            <button class="btn primary" id="authorize">Authorize (payments)</button>
            <button class="btn primary" id="payBtn" disabled>Test Payment 0.01 Ï€</button>
          </div>
        </div>
      </div>

      <div class="search">
        <input id="search" placeholder="Search stores, products..." />
      </div>

      <div class="stats">
        <div class="stat"><strong>2.4K</strong><div style="color:var(--muted)">Stores</div></div>
        <div class="stat"><strong>15K</strong><div style="color:var(--muted)">Products</div></div>
        <div class="stat"><strong>850K</strong><div style="color:var(--muted)">Total Pi</div></div>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Trending</h3><a href="#" style="color:var(--gold);font-weight:700">View all</a>
      </div>

      <div class="grid" id="products">
        <div class="card">
          <div style="height:98px;border-radius:8px;background:linear-gradient(180deg,#061022,#071827)"></div>
          <div style="margin-top:8px;font-weight:700">Pro Course</div>
          <div style="color:var(--muted);font-size:13px">EduPi</div>
          <div style="margin-top:8px;color:var(--gold);font-weight:700">50 Ï€</div>
        </div>
        <div class="card">
          <div style="height:98px;border-radius:8px;background:linear-gradient(180deg,#061022,#071827)"></div>
          <div style="margin-top:8px;font-weight:700">Wireless Earbuds</div>
          <div style="color:var(--muted);font-size:13px">TechHub</div>
          <div style="margin-top:8px;color:var(--gold);font-weight:700">25 Ï€</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="pingServer">Ping Server</button>
        <button class="btn ghost" id="openLogs">Open Logs</button>
      </div>

      <div id="status">Status: idle</div>
      <pre id="log">(logs will appear here)</pre>

      <footer>Made with <span style="color:var(--accent)">ðŸ’™</span> â€” Forza Inter!</footer>
    </div>
  </div>

<script>
/* Client script:
   - Calls /api/approve-payment (POST { paymentId }) to attempt server approval
   - Calls /api/manual-complete?paymentId=...&txid=... for manual finish (demo/testing)
   - If Pi SDK present, it will call Pi.createPayment with the callbacks object
*/

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const checkBtn = document.getElementById('checkSdk');
const authBtn = document.getElementById('authorize');
const payBtn = document.getElementById('payBtn');
const pingBtn = document.getElementById('pingServer');

function log(...args){
  const line = args.map(a=> typeof a==='object'? JSON.stringify(a): String(a)).join(' ');
  logEl.textContent = (new Date().toISOString()) + '  ' + line + '\\n' + logEl.textContent;
  console.log(...args);
}
function setStatus(s){ statusEl.textContent = 'Status: ' + s; log('STATUS', s); }

function sdkCheck(){
  const present = (typeof Pi !== 'undefined');
  const createOk = present && typeof Pi.createPayment === 'function';
  const authOk = present && typeof Pi.authenticate === 'function';
  log('Pi present:', present, 'authenticate:', authOk, 'createPayment:', createOk);
  return { present, createOk, authOk };
}

checkBtn.addEventListener('click', ()=>{
  setStatus('Checking SDK...');
  sdkCheck();
  setStatus('Checked SDK - see log');
});

authBtn.addEventListener('click', async ()=>{
  setStatus('Authenticating (requesting payments scope)...');
  try{
    if(typeof Pi !== 'undefined'){
      try{ Pi.init({version:'2.0'}); }catch(e){ log('Pi.init (caught)', e); }
      const res = await Pi.authenticate(['payments'], (incomplete)=> log('authenticate incomplete', incomplete));
      log('authenticate resolved', res);
      setStatus('Authorized');
      payBtn.disabled = false;
      return;
    }
    // mock path
    setStatus('Authorized (mock)');
    payBtn.disabled = false;
  }catch(err){
    log('Auth error', err);
    setStatus('Auth failed');
    alert('Auth failed: ' + (err && err.message ? err.message : JSON.stringify(err)));
  }
});

async function requestApprove(paymentId){
  setStatus('Requesting server approval...');
  try{
    const r = await fetch('/api/approve-payment', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ paymentId })
    });
    const j = await r.json().catch(()=>({raw:'not-json'}));
    log('/api/approve-payment', r.status, j);
    return { ok:r.ok, status:r.status, data:j };
  }catch(e){
    log('approve request failed', e);
    return { ok:false, error:String(e) };
  }
}

payBtn.addEventListener('click', async ()=>{
  setStatus('Creating payment...');
  log('about to create payment (server-approve flow)');
  const paymentData = { amount:0.01, memo: 'StorePi Demo Payment', metadata:{demo:true} };

  const callbacks = {
    onReadyForServerApproval: async (paymentId)=>{
      log('onReadyForServerApproval', paymentId);
      setStatus('Ready for approval: ' + paymentId);
      const result = await requestApprove(paymentId);
      log('server approve result', result);
      if(result.ok) setStatus('Server approved â€” waiting completion');
      else setStatus('Server approval failed â€” manual fallback');
    },
    onReadyForServerCompletion: (paymentId, txid)=>{
      log('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      alert('Payment completed: ' + paymentId + '\\nTx: ' + txid);
    },
    onCancel: (paymentId)=> { log('onCancel', paymentId); setStatus('Payment canceled'); },
    onError: (err, payment)=> { log('onError', err, payment); setStatus('Payment error'); alert('Payment error'); }
  };

  try{
    if(typeof Pi !== 'undefined' && typeof Pi.createPayment === 'function'){
      Pi.createPayment(paymentData, callbacks);
      log('Pi.createPayment invoked (real SDK)');
    } else {
      // Mock flow (simulate ready -> server -> complete)
      const pid = 'MOCK-' + Math.random().toString(36).slice(2,9);
      callbacks.onReadyForServerApproval && callbacks.onReadyForServerApproval(pid);
      setTimeout(()=> callbacks.onReadyForServerCompletion && callbacks.onReadyForServerCompletion(pid, 'MOCKTX-'+Math.random().toString(36).slice(2,9)), 1200);
      log('Mock payment simulated', pid);
    }
  }catch(e){
    log('createPayment threw', e);
    setStatus('createPayment threw');
  }
});

pingBtn.addEventListener('click', async ()=>{
  setStatus('Pinging server...');
  try{
    const r = await fetch('/api/approve-payment');
    const j = await r.json().catch(()=>({raw:'not-json'}));
    log('/api/approve-payment response', r.status, j);
    setStatus('Ping => ' + r.status);
  }catch(e){
    log('Ping error', e);
    setStatus('Ping error');
  }
});

window.addEventListener('load', ()=>{
  log('Page loaded - SDK check pending');
  const info = sdkCheck();
  setStatus('Loaded - SDK checked');
  if(!info.present) {
    log('Pi SDK not present â€” mock mode enabled');
    payBtn.disabled = false;
  }
});
</script>
</body>
</html>
