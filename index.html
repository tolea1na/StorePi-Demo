<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StorePi â€” Inter Fan Shop</title>
<meta name="description" content="StorePi â€” demo shop to buy digital stickers with Pi. Inter-inspired theme." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000a1a' width='100' height='100' rx='18'/><text x='50' y='58' font-size='50' text-anchor='middle' fill='%230a84ff' font-family='Arial' font-weight='700'>Ï€</text></svg>">
<style>
  :root{
    --bg-dark:#02040a;
    --bg-mid:#07112a;
    --card:#06172b;
    --muted:#9db7d0;
    --accent:#003d7a;   /* deep Inter blue */
    --accent-2:#0a84ff; /* electric blue */
    --gold:#ffc857;
    --radius:14px;
    --glass: rgba(255,255,255,0.02);
    --success:#16a34a;
    color-scheme: dark;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-dark),var(--bg-mid));color:var(--muted);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1100px;margin:20px auto;padding:18px}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:26px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  h1{margin:0;font-size:20px;color:#cfe7ff}
  .lead{margin:4px 0;color:#82a7c6;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px;border-radius:var(--radius);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .product{display:flex;gap:14px;align-items:center}
  .thumb{width:140px;height:110px;border-radius:12px;background:linear-gradient(180deg,#071a3a,#021127);display:flex;align-items:center;justify-content:center;color:var(--accent-2);font-weight:800;font-size:44px}
  .product-info{flex:1}
  .price{font-weight:800;font-size:20px;color:var(--accent-2)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:var(--accent);border:0;color:white;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 22px rgba(2,6,23,0.6)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .status{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));color:#d9f6ff}
  .log{margin-top:12px;background:rgba(2,6,23,0.6);padding:12px;border-radius:10px;color:#9fd6ff;font-family:monospace;white-space:pre-wrap;max-height:300px;overflow:auto}
  .right{display:none}
  .footer{margin-top:16px;text-align:center;color:#88b0d0;font-size:13px}
  .receipt{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#02223f,#021427);color:#dff6ff}
  .tx{font-family:monospace;word-break:break-all;color:#9fd6ff}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#073b70,#0a84ff);color:white;font-weight:700}
  .hidden{display:none}
  .note{margin-top:10px;color:#8fa8c6;font-size:13px}
  @media(min-width:860px){
    .grid{grid-template-columns:1fr 360px}
    .right{display:block}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo" aria-hidden="true">SP</div>
      <div>
        <h1>StorePi â€” Inter Fan Shop</h1>
        <div class="lead">Buy a demo sticker pack with Pi â€” server-approved flow. Open in <strong>Pi Browser</strong> to test real payments.</div>
      </div>
      <div style="margin-left:auto"><span class="badge">Demo</span></div>
    </div>

    <div class="grid">
      <main class="card" aria-labelledby="productTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Featured</div>
            <div id="productTitle" style="font-size:18px;font-weight:800;color:#dff6ff">Digital Sticker Pack â€” Nerazzurri</div>
          </div>
          <div class="price">0.01 Pi</div>
        </div>

        <div style="height:12px"></div>

        <div class="product">
          <div class="thumb" aria-hidden="true">âš½</div>
          <div class="product-info">
            <div style="color:var(--muted)">A curated pack of Inter-inspired stickers â€” perfect for chat and profiles. Instant delivery after payment.</div>
            <div class="controls" role="group" aria-label="Actions">
              <button id="payBtn" class="btn" aria-label="Buy 0.01 Pi">Buy 0.01 Pi</button>
              <button id="authBtn" class="btn ghost" aria-label="Authorize app">Authorize (payments)</button>
              <button id="checkBtn" class="btn ghost" aria-label="Check SDK">Check SDK</button>
            </div>
          </div>
        </div>

        <div id="status" class="status">Status: idle</div>

        <div id="log" class="log">Logs will appear here...</div>

        <div class="note">Made with <span style="color:#0a84ff">ðŸ’™</span> â€” Forza Inter!</div>
      </main>

      <aside class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Receipt Center</strong></div>
            <div class="small">Quick support</div>
          </div>

          <div id="receipt" class="receipt hidden" aria-hidden="true">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Receipt</strong></div>
              <div class="badge">Paid</div>
            </div>
            <div style="height:8px"></div>
            <div class="small">Item: Digital Sticker Pack</div>
            <div style="height:8px"></div>
            <div>Amount: <strong>0.01 Pi</strong></div>
            <div style="height:8px"></div>
            <div>Payment ID: <div class="tx" id="paymentId"></div></div>
            <div style="height:8px"></div>
            <div>Tx ID: <div class="tx" id="txid"></div></div>
            <div style="height:8px"></div>
            <div><a id="txlink" class="small" target="_blank" rel="noreferrer">View on Testnet</a></div>
            <div style="height:10px"></div>
            <div style="display:flex;gap:8px">
              <button id="closeReceipt" class="btn ghost">Close</button>
              <button id="manualComplete" class="btn">Force Complete</button>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="small">Server endpoint:</div>
          <div class="small"><code>/api/approve-payment</code></div>
          <div style="height:8px"></div>
          <div class="small">Env: <code>PI_API_KEY</code> (Vercel)</div>
        </div>
      </aside>
    </div>

    <div class="footer">Â© StorePi Demo â€” built with <span style="color:#0a84ff">ðŸ’™</span></div>
  </div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* ---------- UI helpers ---------- */
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const payBtn = document.getElementById('payBtn');
const authBtn = document.getElementById('authBtn');
const checkBtn = document.getElementById('checkBtn');
const receipt = document.getElementById('receipt');
const paymentIdEl = document.getElementById('paymentId');
const txidEl = document.getElementById('txid');
const txlink = document.getElementById('txlink');
const closeReceipt = document.getElementById('closeReceipt');
const manualComplete = document.getElementById('manualComplete');

function stamp(){ return new Date().toISOString(); }
function appendLog(...args){
  const text = args.map(a => (typeof a==='object' ? JSON.stringify(a) : String(a))).join(' ');
  const line = stamp() + '  ' + text;
  logEl.textContent = line + '\\n' + logEl.textContent;
  console.log(...args);
}
function setStatus(s){ statusEl.textContent = 'Status: ' + s; appendLog('STATUS', s); }
function showReceipt(pid, tx){ receipt.classList.remove('hidden'); receipt.setAttribute('aria-hidden','false'); paymentIdEl.textContent = pid; txidEl.textContent = tx || '(none)'; txlink.href = tx ? ('https://api.testnet.minepi.com/transactions/' + tx) : '#'; }
function hideReceipt(){ receipt.classList.add('hidden'); receipt.setAttribute('aria-hidden','true'); }

/* ---------- init Pi SDK ---------- */
try {
  if (typeof Pi !== 'undefined' && typeof Pi.init === 'function') {
    Pi.init({ version: "2.0" });
    appendLog('âœ… Pi SDK initialized (if in Pi Browser)');
  } else {
    appendLog('Pi object missing â€” open this app inside Pi Browser for real payments.');
  }
} catch(e){ appendLog('Pi.init error', e); }

/* ---------- check ---------- */
checkBtn.addEventListener('click', () => {
  const present = typeof Pi !== 'undefined';
  const hasAuth = present && typeof Pi.authenticate === 'function';
  const hasCreate = present && typeof Pi.createPayment === 'function';
  appendLog('Pi present:', present, 'authenticate:', hasAuth, 'createPayment:', hasCreate);
  setStatus('Checked SDK - see log');
});

/* ---------- authorize ---------- */
authBtn.addEventListener('click', async () => {
  if (typeof Pi === 'undefined'){ alert('Open this page in the Pi Browser to authorize'); return; }
  setStatus('Authenticating (requesting payments scope)...');
  appendLog('Calling Pi.authenticate with scopes ["payments"]');
  try {
    const res = await Pi.authenticate(['payments'], function(incomplete){ appendLog('authenticate incomplete callback', incomplete); });
    appendLog('authenticate resolved:', res);
    setStatus('Authorized');
    alert('Authorized â€” you can now make payments.');
  } catch(err) {
    appendLog('Auth error', err);
    setStatus('Auth failed');
    alert('Authorization failed. Re-open from My Apps and try again.');
  }
});

/* ---------- server approve helper ---------- */
async function serverApprove(paymentId, txid = null) {
  try {
    const body = { paymentId };
    if (txid) body.txid = txid;
    const r = await fetch('/api/approve-payment', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    const text = await r.text();
    appendLog('/api/approve-payment response', r.status, text);
    return { ok: r.ok, status: r.status, raw: text };
  } catch(e) {
    appendLog('serverApprove error', e);
    return { ok:false, error: String(e) };
  }
}

/* ---------- buy flow ---------- */
payBtn.addEventListener('click', async () => {
  hideReceipt();
  if (typeof Pi === 'undefined' || typeof Pi.createPayment !== 'function'){ alert('Open in Pi Browser and authorize first.'); return; }
  setStatus('Creating payment...');
  appendLog('about to call Pi.createPayment (server-approve flow)');
  const payload = { amount: 0.01, memo: 'StorePi Demo Payment', metadata:{ productId:'stickers-001' } };

  const callbacks = {
    onReadyForServerApproval: async function(paymentId){
      appendLog('onReadyForServerApproval', paymentId);
      setStatus('Ready for approval: ' + paymentId);
      // Immediately request server approve (no txid yet)
      setStatus('Requesting server approval...');
      const res = await serverApprove(paymentId, null);
      if (res.ok) setStatus('Server approved â€” waiting for completion');
      else setStatus('Server approval failed');
    },
    onReadyForServerCompletion: function(paymentId, txid){
      appendLog('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      showReceipt(paymentId, txid);
      // Also notify server with txid to ensure completion persisted
      serverApprove(paymentId, txid).then(r => appendLog('serverApprove (post-tx) result', r));
    },
    onCancel: function(paymentId){
      appendLog('onCancel', paymentId);
      setStatus('Payment canceled');
      alert('Payment canceled by user.');
    },
    onError: function(err, payment){
      appendLog('onError', err, payment);
      setStatus('Payment error');
      alert('Payment error â€” check logs.');
    }
  };

  try {
    Pi.createPayment(payload, callbacks);
    appendLog('Pi.createPayment invoked.');
  } catch(e) {
    appendLog('createPayment threw', e);
    setStatus('createPayment threw error');
    alert('Error creating payment: ' + (e && e.message ? e.message : String(e)));
  }
});

/* ---------- manual complete button ---------- */
manualComplete.addEventListener('click', async () => {
  const pid = paymentIdEl.textContent || prompt('Enter paymentId to complete:');
  if (!pid) return;
  try {
    const r = await fetch('/api/manual-complete?paymentId=' + encodeURIComponent(pid));
    const text = await r.text();
    appendLog('manual-complete', r.status, text);
    alert('manual-complete result: ' + text);
  } catch(e) {
    appendLog('manual-complete error', e);
    alert('Error');
  }
});

closeReceipt.addEventListener('click', hideReceipt);
</script>
</body>
</html>
