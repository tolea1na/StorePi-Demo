<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StorePi ‚Äî Demo Store (Working)</title>
<meta name="description" content="StorePi ‚Äî polished demo store for Pi payments. Demo mode ON by default to test easily." />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%2300121f' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='62' font-size='48' text-anchor='middle' fill='%230a84ff' font-family='Arial'%3E%CF%80%3C/text%3E%3C/svg%3E">
<style>
  :root{
    --bg1:#041226; --bg2:#07162b; --accent:#0a84ff; --muted:#9bb3c8; --white:#e6f3ff; --radius:14px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--white)}
  .wrap{max-width:1100px;margin:28px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;padding:14px;border-radius:14px;background:linear-gradient(90deg,#021724,#071a2b);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,var(--accent),#00336f);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
  .controls-top{margin-left:auto;display:flex;gap:8px;align-items:center}
  .tag{background:linear-gradient(90deg,#ffd77a,#ffc857);padding:6px 8px;border-radius:10px;color:#122233;font-weight:800;font-size:12px}
  .grid{display:grid;grid-template-columns:1fr;gap:18px;margin-top:18px}
  @media(min-width:920px){ .grid{grid-template-columns:1fr 360px} }
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
  .headline{font-size:20px;color:var(--accent);margin:0}
  .lead{color:var(--muted);margin-top:6px}
  .row{display:flex;gap:16px;align-items:center;margin-top:14px}
  .thumb{width:140px;height:110px;border-radius:12px;background:linear-gradient(180deg,#04273e,#05314a);display:flex;align-items:center;justify-content:center;font-size:44px;color:var(--accent);font-weight:900;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .meta{color:var(--muted);font-size:14px}
  .price{font-weight:900;font-size:18px;color:var(--accent);margin-top:8px}
  .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,var(--accent),#0778e6);border:0;color:white;padding:12px 16px;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 12px 30px rgba(8,18,40,0.6);transition:transform .12s ease}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:11px 14px}
  .status{margin-top:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);color:var(--accent);display:inline-block}
  .log{margin-top:12px;background:linear-gradient(180deg,#071227,#041726);padding:12px;border-radius:10px;color:#9fe0ff;font-family:monospace;white-space:pre-wrap;max-height:320px;overflow:auto}
  .row-small{display:flex;gap:8px;align-items:center}
  .switch{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .switch input{display:none}
  .side{position:sticky;top:20px}
  .receipt{border-radius:12px;padding:14px;background:linear-gradient(180deg,#052331,#042c38);border:1px solid rgba(255,255,255,0.02)}
  .receipt h3{margin:0;color:var(--accent)}
  .receipt .meta{color:var(--muted);font-size:13px;margin-top:8px}
  .tx{font-family:monospace;color:var(--accent);word-break:break-all;margin-top:6px}
  .hidden{display:none}
  .small{font-size:13px;color:var(--muted)}
  .pulse{animation:pulse 2.6s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
  canvas.confetti{position:fixed;pointer-events:none;inset:0;mix-blend-mode:screen;z-index:9999}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <h1>StorePi</h1>
          <div class="subtitle">Polished demo store ‚Äî server-approved Pi payments</div>
        </div>
      </div>

      <div class="controls-top">
        <div class="tag">DEMO</div>
        <div class="row-small" title="Use Demo Mode to test outside Pi Browser">
          <label class="switch" id="demoSwitch">
            <input type="checkbox" id="demoMode" checked>
            <span id="demoLabel" class="small">Demo mode: ON</span>
          </label>
        </div>
      </div>
    </header>

    <div class="grid" role="main">
      <main class="card" aria-labelledby="mainTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 id="mainTitle" class="headline">Professional Purchase Flow</h2>
            <div class="lead">Clear actions, helpful feedback, and server-side approval for test payments.</div>
          </div>
          <div style="text-align:right">
            <div class="price" style="font-size:18px">0.01 Pi</div>
            <div class="small" style="color:var(--muted)">Testnet</div>
          </div>
        </div>

        <div class="row" aria-label="Product">
          <div class="thumb" aria-hidden="true">üõçÔ∏è</div>
          <div style="flex:1">
            <div style="font-weight:800;color:var(--white);font-size:16px">Demo Store Item</div>
            <div class="meta">Neutral demo item to validate your integration. The UI focuses on the payment flow and clarity.</div>

            <div class="actions">
              <button id="payBtn" class="btn pulse" aria-label="Buy 0.01 Pi">Buy ‚Äî 0.01 Pi</button>
              <button id="authBtn" class="btn ghost" aria-label="Authorize payments">Authorize (payments)</button>
              <button id="checkBtn" class="btn ghost" aria-label="Check SDK">Check SDK</button>
              <button id="pingBtn" class="btn ghost" aria-label="Ping server">Ping Server</button>
            </div>

            <div id="status" class="status">Status: idle</div>
            <div id="log" class="log" aria-live="polite">Logs will appear here ‚Äî Demo Mode is ON by default.</div>
          </div>
        </div>
      </main>

      <aside class="side">
        <div class="receipt card" id="receiptPanel" aria-hidden="true">
          <h3>Receipt & Actions</h3>
          <div class="meta" id="receiptMeta">No transactions yet ‚Äî make a test purchase.</div>

          <div style="height:10px"></div>
          <div class="small">Payment ID</div>
          <div class="tx" id="paymentId">‚Äî</div>

          <div style="height:8px"></div>
          <div class="small">Tx ID</div>
          <div class="tx" id="txid">‚Äî</div>

          <div style="height:12px"></div>
          <div style="display:flex;gap:8px">
            <button id="openTx" class="btn ghost">Open on Testnet</button>
            <button id="manualComplete" class="btn">Force Complete</button>
          </div>
        </div>
      </aside>
    </div>

    <footer style="margin-top:18px;text-align:center;color:var(--muted)">
      Made with <span style="color:var(--accent)">üíô</span> ‚Äî Forza Inter!
    </footer>
  </div>

  <canvas id="confetti" class="confetti hidden"></canvas>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* Single-file working StorePi ‚Äî demo ON by default, real SDK used if available */
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const payBtn = document.getElementById('payBtn');
const authBtn = document.getElementById('authBtn');
const checkBtn = document.getElementById('checkBtn');
const pingBtn = document.getElementById('pingBtn');
const demoModeCheckbox = document.getElementById('demoMode');
const demoLabel = document.getElementById('demoLabel');

const receiptPanel = document.getElementById('receiptPanel');
const receiptMeta = document.getElementById('receiptMeta');
const paymentIdEl = document.getElementById('paymentId');
const txidEl = document.getElementById('txid');
const openTx = document.getElementById('openTx');
const manualComplete = document.getElementById('manualComplete');

const confettiCanvas = document.getElementById('confetti');

function now(){ return new Date().toISOString(); }
function appendLog(...parts){
  const text = parts.map(p => (typeof p==='object' ? JSON.stringify(p) : String(p))).join(' ');
  const line = now() + '  ' + text;
  logEl.textContent = line + '\\n' + logEl.textContent;
  console.log(...parts);
}
function setStatus(s){ statusEl.textContent = 'Status: ' + s; appendLog('STATUS', s); }
function showReceipt(paymentId, txid, message){
  receiptPanel.removeAttribute('aria-hidden');
  receiptMeta.textContent = message || 'Payment completed';
  paymentIdEl.textContent = paymentId || '‚Äî';
  txidEl.textContent = txid || '‚Äî';
  openTx.onclick = ()=> { if (txid) window.open('https://api.testnet.minepi.com/transactions/' + txid, '_blank'); else alert('No txid'); };
}

/* MOCK Pi SDK for demo/testing (installed only if demo on and real Pi absent) */
function installMockPi(){
  if (window.Pi && typeof window.Pi.createPayment === 'function') return;
  window.Pi = {
    _mockAccessToken:'mock-access-token',
    init(){ appendLog('Mock Pi.init called'); },
    authenticate: function(scopes, incompleteCb){
      appendLog('Mock Pi.authenticate', scopes);
      return new Promise((resolve) => {
        setTimeout(()=> {
          try{ if (typeof incompleteCb === 'function') incompleteCb(false); }catch(e){}
          resolve({ user:{app_id:'demo-app', uid:'demo-user', credentials:{scopes, valid_until:{iso8601:'2099-01-01T00:00:00Z'}}, receiving_email:true}, accessToken:this._mockAccessToken });
        }, 600);
      });
    },
    createPayment: function(paymentData, cbs){
      appendLog('Mock Pi.createPayment', paymentData);
      const paymentId = 'MOCK-' + Math.random().toString(36).slice(2,10);
      setTimeout(()=>{ if (cbs && typeof cbs.onReadyForServerApproval === 'function') cbs.onReadyForServerApproval(paymentId); }, 700);
      setTimeout(()=>{ const tx = 'MOCKTX-' + Math.random().toString(36).slice(2,12); if (cbs && typeof cbs.onReadyForServerCompletion === 'function') cbs.onReadyForServerCompletion(paymentId, tx); }, 2000);
    },
    approvePayment:function(paymentId){ appendLog('Mock Pi.approvePayment', paymentId); }
  };
}

/* Initialize Pi safely; call init right away if Pi exists (or after installing mock) */
function initPi(){
  try {
    if (typeof Pi !== 'undefined' && typeof Pi.init === 'function') {
      Pi.init({ version: "2.0" });
      appendLog('Pi.init called (SDK present)');
      return true;
    } else {
      appendLog('Pi object not detected yet');
      return false;
    }
  } catch(e){
    appendLog('Pi.init error', e);
    return false;
  }
}

/* Demo mode default ON: install mock and init if no real Pi */
if (demoModeCheckbox.checked){
  installMockPi();
  initPi();
}
function updateDemoLabel(){ demoLabel.textContent = 'Demo mode: ' + (demoModeCheckbox.checked ? 'ON' : 'OFF'); }
demoModeCheckbox.addEventListener('change', ()=>{
  updateDemoLabel();
  if (demoModeCheckbox.checked){
    installMockPi();
    initPi();
    appendLog('Demo mode enabled ‚Äî mock SDK installed');
    alert('Demo Mode is ON. You can test the payment flow without Pi Browser.');
  } else {
    appendLog('Demo mode disabled ‚Äî reload page to use real Pi SDK if present');
    alert('Demo Mode is OFF. Reload the page in Pi Browser to use the real SDK.');
  }
});
updateDemoLabel();

/* SERVER APPROVE helper: read body only once and parse safely */
async function serverApprove(paymentId, txid=null){
  try {
    const body = { paymentId };
    if (txid) body.txid = txid;
    const resp = await fetch('/api/approve-payment', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    const text = await resp.text(); // read exactly once
    let data;
    try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
    appendLog('/api/approve-payment', resp.status, data);
    return { ok: resp.ok, status: resp.status, data };
  } catch(e){
    appendLog('serverApprove network error', String(e));
    return { ok:false, error: String(e) };
  }
}

/* BUTTONS: Check / Auth / Ping / Buy / Manual Complete */
checkBtn.addEventListener('click', ()=>{
  const present = typeof Pi !== 'undefined';
  const hasAuth = present && typeof Pi.authenticate === 'function';
  const hasCreate = present && typeof Pi.createPayment === 'function';
  appendLog('SDK check ‚Äî Pi present:', present, 'authenticate:', hasAuth, 'createPayment:', hasCreate);
  setStatus('Checked SDK - see log');
});

authBtn.addEventListener('click', async ()=>{
  if (typeof Pi === 'undefined'){ alert('Pi SDK not present. Enable Demo Mode to test or open in Pi Browser.'); return; }
  setStatus('Authenticating (requesting payments scope)...');
  appendLog('Calling Pi.authenticate with scopes ["payments"]');
  try {
    const res = await Pi.authenticate(['payments'], function(incomplete){ appendLog('authenticate incomplete', incomplete); });
    appendLog('authenticate resolved:', res);
    setStatus('Authorized');
    alert('Authorized ‚Äî you can now make payments.');
  } catch(err){
    appendLog('Auth error', err);
    setStatus('Auth failed');
    alert('Authorization failed: ' + (err && err.message ? err.message : String(err)));
  }
});

pingBtn.addEventListener('click', async ()=>{
  setStatus('Pinging server...');
  appendLog('Pinging /api/approve-payment');
  try{
    const r = await fetch('/api/approve-payment');
    const text = await r.text();
    appendLog('/api/approve-payment ping', r.status, text);
    alert('Ping result: ' + r.status + ' (see logs)');
  }catch(e){
    appendLog('Ping failed', e);
    alert('Ping failed ‚Äî check server');
  }
});

payBtn.addEventListener('click', async ()=>{
  if (typeof Pi === 'undefined' || typeof Pi.createPayment !== 'function'){
    alert('Open in Pi Browser and authorize first ‚Äî or enable Demo Mode to test.');
    return;
  }
  setStatus('Creating payment...');
  appendLog('about to call Pi.createPayment (server-approve flow)');
  const payload = { amount: 0.01, memo: 'StorePi Demo', metadata: { demo:true } };

  const callbacks = {
    onReadyForServerApproval: async function(paymentId){
      appendLog('onReadyForServerApproval', paymentId);
      setStatus('Ready for approval: ' + paymentId);
      setStatus('Requesting server approval...');
      const res = await serverApprove(paymentId, null);
      if (res.ok) setStatus('Server approved ‚Äî waiting for completion');
      else setStatus('Server approval failed');
    },
    onReadyForServerCompletion: function(paymentId, txid){
      appendLog('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      showReceipt(paymentId, txid, 'Payment completed ‚Äî thank you!');
      serverApprove(paymentId, txid).then(r => appendLog('post-complete result', r));
      triggerConfetti();
    },
    onCancel: function(paymentId){
      appendLog('onCancel', paymentId);
      setStatus('Payment canceled');
      alert('Payment cancelled');
    },
    onError: function(err, payment){
      appendLog('onError', err, payment);
      setStatus('Payment error');
      alert('Payment error ‚Äî check logs');
    }
  };

  try {
    Pi.createPayment(payload, callbacks);
    appendLog('Pi.createPayment invoked');
  } catch(e){
    appendLog('createPayment threw', e);
    setStatus('createPayment threw error');
    alert('Error creating payment: ' + (e && e.message ? e.message : String(e)));
  }
});

/* Manual complete (support) */
manualComplete.addEventListener('click', async ()=>{
  const pid = prompt('Payment ID to complete (from logs/receipt):');
  const tx = prompt('Tx ID (optional):');
  if (!pid) return;
  try {
    const qs = new URLSearchParams({ paymentId: pid, txid: tx || '' });
    const r = await fetch('/api/manual-complete?' + qs.toString());
    const txt = await r.text();
    appendLog('manual-complete', r.status, txt);
    alert('Manual-complete result: ' + r.status + ' ‚Äî see logs');
  } catch(e){
    appendLog('manual-complete error', e);
    alert('Error');
  }
});

/* CONFETTI: tasteful burst on completion */
function triggerConfetti(){
  try {
    const canvas = confettiCanvas;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    canvas.classList.remove('hidden');

    const pieces = [];
    const colors = ['#0a84ff','#00bfff','#ffd77a','#ffffff'];
    for (let i=0;i<48;i++){
      pieces.push({
        x: Math.random()*canvas.width,
        y: -Math.random()*canvas.height*0.2,
        vx: (Math.random()-0.5)*6,
        vy: Math.random()*6+2,
        size: (Math.random()*8+4)*dpr,
        color: colors[Math.floor(Math.random()*colors.length)],
        rot: Math.random()*Math.PI*2,
        vr: (Math.random()-0.5)*0.2
      });
    }
    let t = 0;
    function frame(){
      t++;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for (let p of pieces){
        p.x += p.vx; p.y += p.vy; p.vy += 0.12 * dpr; p.rot += p.vr;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
        ctx.fillStyle = p.color; ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
        ctx.restore();
      }
      if (t < 160) requestAnimationFrame(frame);
      else { canvas.classList.add('hidden'); ctx.clearRect(0,0,canvas.width,canvas.height); }
    }
    requestAnimationFrame(frame);
  } catch(e){ console.warn('confetti failed', e); }
}

/* Helpful: try to init Pi again at intervals (in case SDK loads later) */
let piRetryCount = 0;
const piRetryInterval = setInterval(()=> {
  piRetryCount++;
  if (initPi() || piRetryCount > 12) { clearInterval(piRetryInterval); appendLog('Pi init retry stopped'); }
}, 1000);

</script>
</body>
</html>
