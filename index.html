<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StorePi â€” Official Fan Shop</title>
<meta name="description" content="StorePi â€” demo shop to buy digital stickers with Pi. Clean, professional UI inspired by Inter blue." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300121f' width='100' height='100' rx='20'/><text x='50' y='62' font-size='48' text-anchor='middle' fill='%230a84ff' font-family='Arial'>Ï€</text></svg>">
<style>
  /* -----------------------
     BRAND / THEME
     ----------------------- */
  :root{
    --bg:#f5f8fb;        /* soft light background */
    --panel:#ffffff;     /* card background */
    --muted:#6a7b88;
    --ink:#052033;
    --accent:#062e58;    /* deep navy for headings */
    --accent-2:#0a84ff;  /* electric Inter blue (used for CTA & heart) */
    --glass: rgba(10,20,30,0.04);
    --success:#16a34a;
    --radius:14px;
    --shadow: 0 10px 30px rgba(9,20,30,0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* -----------------------
     LAYOUT
     ----------------------- */
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:28px auto;padding:18px}
  header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
  .brand{
    display:flex;gap:12px;align-items:center;
  }
  .logo{
    width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#071a3a,#021227);
    display:flex;align-items:center;justify-content:center;color:var(--accent-2);font-weight:800;font-size:26px;box-shadow:var(--shadow)
  }
  h1{margin:0;font-size:20px;color:var(--accent);line-height:1}
  .tag{color:var(--muted);font-size:13px;margin-top:4px}

  /* -----------------------
     MAIN GRID
     ----------------------- */
  .grid{display:grid;grid-template-columns:1fr;gap:18px}
  @media(min-width:880px){ .grid{grid-template-columns:1fr 360px} }

  .card{background:var(--panel);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
  .hero{display:flex;justify-content:space-between;align-items:center;gap:20px}
  .hero-left{max-width:720px}
  .headline{font-size:22px;color:var(--accent);margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 14px}

  /* -----------------------
     PRODUCT CARD
     ----------------------- */
  .product{display:flex;gap:16px;align-items:center}
  .thumb{
    width:140px;height:110px;border-radius:12px;background:linear-gradient(180deg,#eaf6ff,#dceeff);display:flex;align-items:center;justify-content:center;
    font-weight:800;color:var(--accent-2);font-size:40px;box-shadow:0 8px 20px rgba(10,20,30,0.06)
  }
  .price{font-weight:800;font-size:18px;color:var(--accent-2)}
  .desc{color:var(--muted);font-size:14px}

  /* -----------------------
     ACTIONS
     ----------------------- */
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{
    background:linear-gradient(180deg,var(--accent-2),#0878ff);border:0;color:white;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 22px rgba(10,30,60,0.12);transition:transform .14s ease,box-shadow .14s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent;border:1px solid rgba(6,30,50,0.06);color:var(--muted);font-weight:600;padding:11px 14px}

  .status{margin-top:12px;padding:10px;border-radius:10px;background:var(--glass);color:var(--accent);display:inline-block}
  .log{margin-top:14px;background:#0f2330;padding:12px;border-radius:10px;color:#bfe7ff;font-family:monospace;white-space:pre-wrap;max-height:300px;overflow:auto}

  /* -----------------------
     RIGHT COLUMN (receipt)
     ----------------------- */
  .receipt{border-radius:12px;padding:14px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid rgba(6,30,50,0.03)}
  .receipt h3{margin:0;color:var(--accent)}
  .receipt .tx{font-family:monospace;color:var(--accent-2);word-break:break-all}
  .receipt .meta{color:var(--muted);font-size:13px;margin-top:8px}
  .receipt .actions{display:flex;gap:8px;margin-top:12px}

  /* -----------------------
     FOOTER / MICRO
     ----------------------- */
  footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
  .blueheart{color:var(--accent-2)}

  /* -----------------------
     SMALL UI niceties + animations
     ----------------------- */
  .fade {transition:opacity .28s ease,transform .28s ease}
  .invisible{opacity:0;transform:translateY(6px);pointer-events:none}
  .visible{opacity:1;transform:none;pointer-events:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <h1>StorePi</h1>
          <div class="tag">Official Fan Shop â€” demo payments with Pi</div>
        </div>
      </div>

      <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <div style="font-weight:700;color:var(--muted)">Demo</div>
      </div>
    </header>

    <div class="grid">
      <!-- left -->
      <main class="card">
        <div class="hero">
          <div class="hero-left">
            <div class="headline">Digital Sticker Pack â€” Nerazzurri</div>
            <div class="sub">High-quality, Inter-inspired stickers for chat and social. Instant delivery after payment.</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:28px;font-weight:900;color:var(--accent-2)">0.01 Pi</div>
            <div style="color:var(--muted);font-size:13px">Testnet</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="product">
          <div class="thumb" aria-hidden="true">âš½</div>
          <div style="flex:1">
            <div class="desc">A small pack with 8 exclusive Nerazzurri stickers: badges, chants and mini-logos. Delivered instantly on success.</div>

            <div class="controls">
              <button id="payBtn" class="btn" aria-label="Buy 0.01 Pi">Buy â€” 0.01 Pi</button>
              <button id="authBtn" class="btn ghost" aria-label="Authorize payments">Authorize (payments)</button>
              <button id="checkBtn" class="btn ghost" aria-label="Check SDK">Check SDK</button>
            </div>

            <div id="status" class="status">Status: idle</div>

            <div id="log" class="log" aria-live="polite">Logs will appear here...</div>
          </div>
        </div>
      </main>

      <!-- right -->
      <aside>
        <div class="receipt card" id="receiptCard" aria-hidden="true">
          <h3>Receipt & Status</h3>
          <div class="meta" id="receiptMeta">No payments yet â€” try a test purchase.</div>

          <div style="height:10px"></div>
          <div style="font-size:13px;color:var(--muted)">Payment ID</div>
          <div class="tx" id="receiptPayment">â€”</div>

          <div style="height:8px"></div>
          <div style="font-size:13px;color:var(--muted)">Transaction (txid)</div>
          <div class="tx" id="receiptTx">â€”</div>

          <div style="height:10px"></div>
          <div class="actions">
            <button id="viewTx" class="btn ghost">Open on Testnet</button>
            <button id="manualComplete" class="btn">Force Complete</button>
          </div>
        </div>
      </aside>
    </div>

    <footer>Made with <span class="blueheart">ðŸ’™</span> â€” Forza Inter!</footer>
  </div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
/* -----------------------
   Frontend logic: Pi SDK + server approve flow
   Keep this intact when you paste.
   ----------------------- */
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const payBtn = document.getElementById('payBtn');
const authBtn = document.getElementById('authBtn');
const checkBtn = document.getElementById('checkBtn');
const receiptCard = document.getElementById('receiptCard');
const receiptMeta = document.getElementById('receiptMeta');
const receiptPayment = document.getElementById('receiptPayment');
const receiptTx = document.getElementById('receiptTx');
const viewTx = document.getElementById('viewTx');
const manualComplete = document.getElementById('manualComplete');

function now(){ return new Date().toISOString(); }
function appendLog(...parts){
  const text = parts.map(p => (typeof p==='object' ? JSON.stringify(p) : String(p))).join(' ');
  const line = now() + '  ' + text;
  logEl.textContent = line + '\\n' + logEl.textContent;
  console.log(...parts);
}
function setStatus(s){ statusEl.textContent = 'Status: ' + s; appendLog('STATUS', s); }
function showReceipt(paymentId, txid, message){
  receiptCard.classList.remove('invisible'); receiptCard.classList.add('visible');
  receiptCard.style.display = '';
  receiptMeta.textContent = message || 'Payment completed';
  receiptPayment.textContent = paymentId || 'â€”';
  receiptTx.textContent = txid || 'â€”';
  viewTx.onclick = ()=> { if (txid) window.open('https://api.testnet.minepi.com/transactions/' + txid, '_blank'); else alert('No txid available'); };
}

/* Init SDK */
try {
  if (typeof Pi !== 'undefined' && typeof Pi.init === 'function') {
    Pi.init({ version: "2.0" });
    appendLog('Pi SDK init called (if in Pi Browser)');
  } else {
    appendLog('Pi object missing â€” open in Pi Browser for real payments');
  }
} catch(e){ appendLog('Pi.init error', e); }

/* Check button */
checkBtn.addEventListener('click', ()=>{
  const present = typeof Pi !== 'undefined';
  const hasAuth = present && typeof Pi.authenticate === 'function';
  const hasCreate = present && typeof Pi.createPayment === 'function';
  appendLog('Pi present:', present, 'authenticate:', hasAuth, 'createPayment:', hasCreate);
  setStatus('Checked SDK - see log');
});

/* Authorize */
authBtn.addEventListener('click', async ()=>{
  if (typeof Pi === 'undefined'){ alert('Open this page in Pi Browser to authorize'); return; }
  setStatus('Authenticating (requesting payments scope)...');
  appendLog('Calling Pi.authenticate with scopes ["payments"]');
  try {
    const res = await Pi.authenticate(['payments'], function(incomplete){ appendLog('authenticate incomplete callback', incomplete); });
    appendLog('authenticate resolved:', res);
    setStatus('Authorized');
    alert('Authorized â€” you can now make payments.');
  } catch(err){
    appendLog('Auth error', err);
    setStatus('Auth failed');
    alert('Authorization failed. Re-open from My Apps and try again.');
  }
});

/* helper: post approve to server */
async function postApprove(paymentId, txid=null){
  try {
    const r = await fetch('/api/approve-payment', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ paymentId, txid })
    });
    const txt = await r.text();
    appendLog('/api/approve-payment response', r.status, txt);
    return { ok: r.ok, status: r.status, text: txt };
  } catch(e){
    appendLog('postApprove error', e);
    return { ok:false, error: String(e) };
  }
}

/* Buy flow */
payBtn.addEventListener('click', ()=>{
  if (typeof Pi === 'undefined' || typeof Pi.createPayment !== 'function'){ alert('Open in Pi Browser and authorize first'); return; }
  setStatus('Creating payment...');
  appendLog('about to call Pi.createPayment (server-approve flow)');
  const payload = { amount: 0.01, memo: 'StorePi â€” Sticker Pack', metadata: { product:'stickers-nerazzurri' } };

  const callbacks = {
    onReadyForServerApproval: async function(paymentId){
      appendLog('onReadyForServerApproval', paymentId);
      setStatus('Ready for approval: ' + paymentId);
      // request server to approve (no txid yet)
      setStatus('Requesting server approval...');
      const res = await postApprove(paymentId, null);
      if (res.ok) setStatus('Server approved â€” waiting for completion');
      else setStatus('Server approval failed');
    },
    onReadyForServerCompletion: function(paymentId, txid){
      appendLog('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      showReceipt(paymentId, txid, 'Payment completed â€” thank you!');
      // inform server with txid as well (best effort)
      postApprove(paymentId, txid).then(r=> appendLog('postComplete result', r));
    },
    onCancel: function(paymentId){
      appendLog('onCancel', paymentId);
      setStatus('Payment canceled');
      alert('Payment cancelled.');
    },
    onError: function(err, payment){
      appendLog('onError', err, payment);
      setStatus('Payment error');
      alert('Payment error â€” check logs.');
    }
  };

  try {
    Pi.createPayment(payload, callbacks);
    appendLog('Pi.createPayment invoked');
  } catch(e){
    appendLog('createPayment threw', e);
    setStatus('createPayment threw error');
    alert('Error creating payment: ' + (e && e.message ? e.message : String(e)));
  }
});

/* Manual complete for support */
manualComplete.addEventListener('click', async ()=>{
  const pid = receiptPayment.textContent || prompt('Payment ID to complete:');
  if (!pid) return;
  try {
    const r = await fetch('/api/manual-complete?paymentId=' + encodeURIComponent(pid));
    const txt = await r.text();
    appendLog('manual-complete', r.status, txt);
    alert('Manual-complete result: ' + txt);
  } catch(e){
    appendLog('manual-complete error', e);
    alert('Error');
  }
});
</script>
</body>
</html>
