<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StorePi Demo â€” Server Approve</title>
<!-- Pi SDK (real) -->
<script src="https://sdk.minepi.com/pi-sdk.js" defer></script>

<style>
  /* ===== Typography & base ===== */
  :root{
    --bg:#071327;           /* page bg (deep) */
    --card:#081826;         /* dark card background */
    --panel:#0b1a2a;        /* slightly lighter */
    --text:#eaf6ff;         /* soft white */
    --muted:#a7bbcc;        /* muted */
    --accent-blue:#0f6fff;  /* Inter-ish blue */
    --accent-dark:#031026;
    --gold:#e0a401;         /* small yellow accent */
    --glass: rgba(255,255,255,0.03);
    --radius:14px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#06111a 0%, #071327 100%);color:var(--text);}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
  .frame{
    width:100%;max-width:420px;border-radius:28px;padding:18px;background:
      linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 12px 40px rgba(3,8,18,0.6), inset 0 -1px 0 rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
  }

  header{display:flex;align-items:center;gap:12px}
  .logo {
    width:52px;height:52px;border-radius:12px;background:linear-gradient(180deg,var(--accent-blue),#0d4fd5);
    display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:22px;
    box-shadow: 0 6px 18px rgba(15,111,255,0.18);
  }
  .brand {flex:1}
  .brand h1{margin:0;font-size:18px;font-weight:700;}
  .brand p{margin:0;color:var(--muted);font-size:12px}
  .createBtn{background:linear-gradient(180deg,var(--gold),#d68b00);color:#051027;padding:10px 14px;border-radius:12px;border:0;font-weight:600;cursor:pointer;box-shadow:0 8px 18px rgba(224,164,1,0.12)}

  /* hero / stats */
  .hero{margin-top:16px;background:linear-gradient(180deg, rgba(15,111,255,0.06), rgba(255,255,255,0.01)); padding:16px;border-radius:16px;display:flex;gap:12px;align-items:center}
  .bigHeart{width:64px;height:64px;border-radius:14px;background:linear-gradient(180deg,#0f6fff,#0a4fd1);display:flex;align-items:center;justify-content:center;color:white;font-size:28px;box-shadow:0 8px 30px rgba(15,111,255,0.14)}
  .heroText h2{margin:0;font-size:18px}
  .heroText p{margin:6px 0 0;color:var(--muted);font-size:13px}

  .search{margin-top:14px;display:flex;gap:8px;align-items:center}
  .search input{
    flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));color:var(--text);
  }
  .search .clip{width:46px;height:46px;border-radius:10px;background:var(--gold);display:flex;align-items:center;justify-content:center;color:#051027;font-weight:700}

  /* cards row */
  .cards{display:flex;gap:12px;margin-top:14px}
  .stat{flex:1;background:var(--glass);padding:12px;border-radius:12px;min-height:80px;display:flex;flex-direction:column;justify-content:center}
  .stat strong{font-size:20px;display:block}
  .stat small{color:var(--muted);font-size:12px}

  /* product list */
  .sectionTitle{margin-top:18px;display:flex;align-items:center;justify-content:space-between}
  .sectionTitle h3{margin:0}
  .grid{display:flex;gap:12px;margin-top:12px;overflow:auto;padding-bottom:12px}
  .cardItem{min-width:160px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,0.03)}
  .cardItem .img{height:100px;background:linear-gradient(180deg,#0b1a2a,#071327);border-radius:10px}
  .price{margin-top:8px;color:var(--gold);font-weight:700}

  /* action row */
  .actions{display:flex;gap:8px;margin-top:18px;align-items:center}
  .btn {padding:10px 12px;border-radius:12px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(180deg,var(--accent-blue),#0a58ff);color:white;box-shadow:0 8px 24px rgba(15,111,255,0.12)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)}

  /* debug console */
  #status{margin-top:14px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);color:var(--muted)}
  #log{margin-top:10px;background:#041026;padding:12px;border-radius:10px;height:160px;overflow:auto;font-family:monospace;color:#bfe6ff;font-size:12px}

  footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center;padding-bottom:8px}
  footer .made{color:var(--muted)} footer .heart{color:#0f6fff;font-weight:700;margin-left:6px}

  /* small responsiveness */
  @media (max-width:420px){
    .cards{flex-direction:row}
  }

  /* subtle animations */
  .fade-up { transform: translateY(10px); opacity: 0; animation: fadeUp .5s forwards; }
  @keyframes fadeUp { to { transform: none; opacity:1; } }
</style>
</head>
<body>
<div class="wrap">
  <div class="frame fade-up" role="main" aria-live="polite">
    <header>
      <div class="logo" aria-hidden>ðŸ’™</div>
      <div class="brand">
        <h1>StorePi</h1>
        <p>Pi-native marketplace â€” demo</p>
      </div>
      <button class="createBtn" id="createStoreBtn">+ Create Store</button>
    </header>

    <div class="hero">
      <div class="bigHeart" aria-hidden>ðŸ’™</div>
      <div class="heroText">
        <h2>Sell & Accept Pi â€” Demo</h2>
        <p>Accept Pi test payments instantly. Designed for mobile-first, polished UI.</p>
      </div>
    </div>

    <div class="search">
      <input id="search" placeholder="Search stores, products, creators..." />
      <div class="clip">Ï€</div>
    </div>

    <div class="cards">
      <div class="stat"><strong>2.4K</strong><small>Active Stores</small></div>
      <div class="stat"><strong>15K</strong><small>Products</small></div>
      <div class="stat"><strong>850K</strong><small>Total Pi Sold</small></div>
    </div>

    <div class="sectionTitle">
      <h3>Trending Now</h3>
      <a href="#" style="color:var(--gold);font-weight:700;font-size:14px">View All</a>
    </div>

    <div class="grid" id="products">
      <div class="cardItem">
        <div class="img"></div>
        <div style="margin-top:8px;font-weight:700">Pro Course</div>
        <div style="color:var(--muted);font-size:13px">EduPi</div>
        <div class="price">50 Ï€</div>
      </div>
      <div class="cardItem">
        <div class="img"></div>
        <div style="margin-top:8px;font-weight:700">Wireless Earbuds</div>
        <div style="color:var(--muted);font-size:13px">Tech Hub</div>
        <div class="price">25 Ï€</div>
      </div>
      <div class="cardItem">
        <div class="img"></div>
        <div style="margin-top:8px;font-weight:700">Digital Poster</div>
        <div style="color:var(--muted);font-size:13px">Creator</div>
        <div class="price">5 Ï€</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="checkSdk">Check SDK</button>
      <button class="btn btn-primary" id="authorize">Authorize (payments)</button>
      <button class="btn btn-primary" id="payBtn" disabled>Test Payment 0.01 Pi</button>
      <button class="btn btn-ghost" id="pingServer">Ping Server</button>
    </div>

    <div id="status">Status: idle</div>
    <div id="log">(logs will appear here)</div>

    <footer>
      <div class="made">Made with <span class="heart">ðŸ’™</span> â€” Forza Inter!</div>
    </footer>
  </div>
</div>

<script>
/*
  StorePi Demo index.html
  - Works with real Pi Browser SDK and server-approve flows
  - Paste this file into your index.html and deploy.
*/

/* ---------- Utilities ---------- */
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const checkBtn = document.getElementById('checkSdk');
const authBtn = document.getElementById('authorize');
const payBtn = document.getElementById('payBtn');
const pingBtn = document.getElementById('pingServer');

function addLog(...args){
  const t = new Date().toISOString();
  const line = args.map(a => {
    if (typeof a === 'object') {
      try { return JSON.stringify(a); } catch(e){ return String(a); }
    }
    return String(a);
  }).join(' ');
  logEl.textContent = t + '  ' + line + '\n' + logEl.textContent;
  console.log(...args);
}
function setStatus(s){
  statusEl.textContent = 'Status: ' + s;
  addLog('STATUS', s);
}

/* ---------- Pi SDK detection & init ---------- */
let sdkPresent = false;
let sdkReady = false;
let lastPaymentId = null;

function checkPiSDK(){
  const present = (typeof Pi !== 'undefined');
  const hasInit = present && typeof Pi.init === 'function';
  const hasAuth = present && typeof Pi.authenticate === 'function';
  const hasCreate = present && typeof Pi.createPayment === 'function';
  addLog('Pi present:', present, 'init:', !!hasInit, 'authenticate:', !!hasAuth, 'createPayment:', !!hasCreate);
  return { present, hasInit, hasAuth, hasCreate };
}

function safeInitPi(){
  if (typeof Pi === 'undefined') {
    addLog('Pi SDK not found in this browser (not Pi Browser). Demo will use mock mode.');
    return false;
  }
  try {
    Pi.init({ version: "2.0" });
    addLog('âœ… Pi.init called');
    return true;
  } catch(e){
    addLog('Pi.init error', e);
    return false;
  }
}

/* ---------- Mock fallback (for testing outside Pi Browser) ---------- */
const MOCK = {
  enabled: false,
  authenticate: async (scopes) => {
    // simulated authenticate
    return { user:{ app_id:'demo-app', uid:'demo-user', credentials:{ scopes:['payments'], valid_until:{iso8601:'2099-01-01T00:00:00Z'} } }, accessToken:'mock-access-token' };
  },
  createPayment: (data, callbacks) => {
    // simulate ready for server approval then completion
    const pid = 'MOCK-' + Math.random().toString(36).slice(2,9);
    addLog('MOCK createPayment invoked, id:', pid);
    setTimeout(()=>{ if (callbacks && callbacks.onReadyForServerApproval) callbacks.onReadyForServerApproval(pid); }, 600);
    // server approve simulation (mock)
    setTimeout(()=>{ if (callbacks && callbacks.onReadyForServerCompletion) callbacks.onReadyForServerCompletion(pid, 'MOCKTX-'+Math.random().toString(36).slice(2,10)); }, 1600);
    return pid;
  }
};

/* ---------- Server approval function ---------- */
async function requestServerApprove(paymentId){
  setStatus('Requesting server approval...');
  addLog('Requesting server approval for', paymentId);
  try {
    // POST to /api/approve-payment (server function) - adjust path if needed
    const resp = await fetch('/api/approve-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentId })
    });
    let data;
    try { data = await resp.json(); } catch(e){ data = {rawText: await resp.text().catch(()=>null)}; }
    addLog('/api/approve-payment response', resp.status, data);
    return { ok: resp.ok, status: resp.status, data };
  } catch(e){
    addLog('Server approve error', e);
    return { ok:false, error: String(e) };
  }
}

/* ---------- Wire buttons ---------- */
checkBtn.addEventListener('click', ()=>{
  const info = checkPiSDK();
  setStatus('Checked SDK - see log');
  if(info.present && info.hasInit && info.hasAuth && info.hasCreate){
    addLog('SDK seems fully present on page.');
  } else {
    addLog('SDK not fully present â€” if you are on phone, open this URL inside the Pi Browser (not Chrome).');
  }
});

authBtn.addEventListener('click', async ()=>{
  setStatus('Authenticating (requesting payments scope)...');
  addLog('Calling Pi.authenticate with scopes ["payments"]');
  try {
    if (typeof Pi !== 'undefined') {
      // ensure init called
      try { Pi.init({ version: "2.0" }); addLog('Pi.init (re)called'); } catch(e){}
      const res = await Pi.authenticate(['payments'], function(incomplete){ addLog('authenticate incomplete callback', incomplete); });
      addLog('authenticate resolved:', res);
      setStatus('Authorized');
      payBtn.disabled = false;
      return;
    }
    // fallback
    const r = await MOCK.authenticate(['payments']);
    addLog('MOCK authenticate resolved', r);
    setStatus('Authorized (mock)');
    payBtn.disabled = false;
  } catch(err){
    addLog('Auth error detailed', err);
    setStatus('Auth failed');
    alert('Authorization failed: ' + (err && err.message ? err.message : JSON.stringify(err)));
  }
});

/* Payment flow with object callbacks (server-approve) */
payBtn.addEventListener('click', async ()=>{
  setStatus('Creating payment...');
  addLog('about to call Pi.createPayment (server-approve flow)');
  const paymentData = { amount: 0.01, memo: 'StorePi Demo Payment', metadata: { demo:true } };

  const callbacks = {
    onReadyForServerApproval: async function(paymentId){
      addLog('onReadyForServerApproval', paymentId);
      lastPaymentId = paymentId;
      setStatus('Ready for approval: ' + paymentId);
      // call server to approve
      const result = await requestServerApprove(paymentId);
      addLog('requestServerApprove result', result);
      if (result.ok) {
        setStatus('Server approved â€” waiting for completion');
      } else {
        setStatus('Server approval failed â€” you can manually complete with /api/manual-complete');
      }
    },
    onReadyForServerCompletion: function(paymentId, txid){
      addLog('onReadyForServerCompletion', paymentId, txid);
      setStatus('Payment completed');
      alert('Payment completed: ' + paymentId + '\nTx: ' + txid);
      lastPaymentId = null;
    },
    onCancel: function(paymentId){
      addLog('onCancel', paymentId);
      setStatus('Payment canceled');
      lastPaymentId = null;
    },
    onError: function(err, payment){
      addLog('onError', err, payment);
      setStatus('Payment error');
      lastPaymentId = null;
      alert('Payment error: ' + (err && err.message ? err.message : JSON.stringify(err)));
    }
  };

  try {
    if (typeof Pi !== 'undefined' && typeof Pi.createPayment === 'function') {
      Pi.createPayment(paymentData, callbacks);
      addLog('Pi.createPayment invoked.');
    } else {
      // fallback mock
      MOCK.enabled = true;
      MOCK.createPayment(paymentData, callbacks);
    }
  } catch(e){
    addLog('createPayment threw', e);
    setStatus('createPayment threw error');
  }
});

pingBtn.addEventListener('click', async ()=>{
  setStatus('Pinging server...');
  addLog('Pinging /api/approve-payment');
  try {
    const r = await fetch('/api/approve-payment');
    const j = await r.json().catch(()=>({raw: 'not-json'}));
    addLog('/api/approve-payment response', r.status, j);
    setStatus('/api/approve-payment -> ' + r.status);
  } catch(e){
    addLog('Ping server error', e);
    setStatus('Ping error');
  }
});

/* ---------- Auto-check on load ---------- */
window.addEventListener('load', ()=>{
  addLog('Page loaded - SDK check pending');
  const presence = checkPiSDK();
  if (presence.present) {
    const ok = safeInitPi();
    if (!ok) addLog('Warning: Pi.init failed.');
  } else {
    addLog('Pi SDK not found â€” demo will continue in mock mode (you can still test).');
  }
  setStatus('Loaded - SDK checked');
  // enable pay button if mock or if SDK present + auth
  if (!presence.present) {
    payBtn.disabled = false; // allow mock payment
    addLog('Mock payments enabled (outside Pi Browser).');
  }
});
</script>
</body>
</html>
